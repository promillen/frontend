name: Sync to Organization Repo

on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.SYNC_TOKEN }}

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

    - name: Add organization remote and push
      run: |
        git remote add org https://x-access-token:${{ secrets.SYNC_TOKEN }}@github.com/MOC-IoT/Frontend.git
        
        # Try to fetch, but don't fail if repo is empty
        echo "üì° Fetching from organization repository..."
        git fetch org || echo "‚ÑπÔ∏è  Organization repository appears to be empty (this is normal for initial setup)"
        
        # Check if org/main exists
        if git rev-parse --verify org/main >/dev/null 2>&1; then
          echo "‚úÖ Organization repository has existing main branch"
          
          # Check for conflicts since both repos have content
          if ! git merge-base --is-ancestor org/main HEAD && ! git merge-base --is-ancestor HEAD org/main; then
            echo "‚ö†Ô∏è  Warning: Potential merge conflicts detected"
            echo "Both repositories have diverged. Manual intervention may be required."
            echo "Organization repo latest commit: $(git log --oneline -1 org/main)"
            echo "Personal repo latest commit: $(git log --oneline -1 HEAD)"
            exit 1
          fi
          
          echo "‚úÖ No conflicts detected"
        else
          echo "‚ÑπÔ∏è  Organization repository is empty - performing initial sync"
        fi
        
        # Push to organization repo (this will create the main branch if it doesn't exist)
        echo "üöÄ Pushing to organization repository..."
        git push org main:main

    - name: Check sync status
      run: |
        echo "‚úÖ Successfully synced to organization repository"
        git log --oneline -5
