name: Sync to Organization Repo

on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.SYNC_TOKEN }}

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

    - name: Add organization remote and push
      run: |
        git remote add org https://x-access-token:${{ secrets.SYNC_TOKEN }}@github.com/MOC-IoT/Frontend.git
        
        # Try to fetch, but don't fail if repo is empty
        echo "ðŸ“¡ Fetching from organization repository..."
        git fetch org || echo "â„¹ï¸  Organization repository appears to be empty (this is normal for initial setup)"
        
        # Check if org/main exists
        if git rev-parse --verify org/main >/dev/null 2>&1; then
          echo "âœ… Organization repository has existing main branch"
          
          # Check for conflicts since both repos have content
          if ! git merge-base --is-ancestor org/main HEAD && ! git merge-base --is-ancestor HEAD org/main; then
            echo "âš ï¸  Divergence detected; continuing with force push (expected due to workflow file differences)"
            echo "Organization repo latest commit: $(git log --oneline -1 org/main)"
            echo "Personal repo latest commit: $(git log --oneline -1 HEAD)"
          else
            echo "âœ… No conflicts detected"
          fi
        else
          echo "â„¹ï¸  Organization repository is empty - performing initial sync"
        fi
        
        # Push to organization repo (this will create the main branch if it doesn't exist)
        echo "ðŸš€ Pushing to organization repository..."
        
        # Create a temporary branch without conflicting workflow files
        git checkout -b temp-sync-branch
        
        # Remove the sync-to-org workflow from the temp branch (we don't want it in the org repo)
        git rm .github/workflows/sync-to-org.yml 2>/dev/null || true
        
        # If there's a sync-to-personal.yml in this repo, remove it too
        git rm .github/workflows/sync-to-personal.yml 2>/dev/null || true
        
        git commit -m "[skip ci] Remove conflicting sync workflows for org push" --allow-empty
        
        # Push the clean branch to org repo (force push to resolve conflicts)
        git push --force org temp-sync-branch:main
        
        # Clean up temp branch
        git checkout main
        git branch -D temp-sync-branch

    - name: Check sync status
      run: |
        echo "âœ… Successfully synced to organization repository"
        git log --oneline -5
